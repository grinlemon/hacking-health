<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <title>OCR Scanner PWA</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk9DUiBTY2FubmVyIFBXQSIsCiAgInNob3J0X25hbWUiOiAiT0NSIFBXQSIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiM0RjQ2RTUiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhNakFpSUdobGFXZG9kRDBpTVRJd0lqNDhjbVZqZENCM2FXUjBhRDBpTVRJd0lpQm9aV2xuYUhROUlqRXlNQ0lnWm1sc2JEMGlJelJHTkRaRk5TSXZQanh3WVhSb0lHUTlJazB6TUNBMk1HTXRNVFlnTUMweE9TMHpMakl0TVM0eUxURXdJREF0TVRZdU9DQXhNaTQ0TFRFeExqZ2dNamN1TnkweE55NHpJRGswTGpJdE1UY3VNeUE1TkM0eUxUTTRJREF0T0RFdU1TMDFNUzQxTFRrMExqSXRPVFF1TWlJZ2MzUnliMnRsUFNJak1URkZSREUxSWlCbWFXeHNQU0p1YjI1bElpQnpkSEp2YTJVdGQybGtkR2c5SWpJaUx6NDhMM04yWno0PSIsCiAgICAgICJzaXplcyI6ICIxMjB4MTIwIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #4F46E5;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
        }

        video, canvas {
            width: 100%;
            border-radius: 10px;
            background: #000;
        }

        canvas {
            display: none;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4F46E5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338CA;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #10B981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #EF4444;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .status-info {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .status-success {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-error {
            background: #FEE2E2;
            color: #991B1B;
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            background: #F9FAFB;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .result h3 {
            color: #4F46E5;
            margin-bottom: 10px;
        }

        .result p {
            line-height: 1.6;
            color: #374151;
        }

        .hidden {
            display: none;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4F46E5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-preview {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ OCR Scanner PWA</h1>
        
        <div id="status" class="status status-info">
            Pr√™t √† scanner un document
        </div>

        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <img id="preview" class="image-preview hidden" alt="Preview">
        </div>

        <button id="startCamera" class="btn btn-primary">
            üì∑ D√©marrer la cam√©ra
        </button>
        
        <button id="capture" class="btn btn-success hidden" disabled>
            üì∏ Capturer l'image
        </button>

        <button id="process" class="btn btn-primary hidden">
            üîç Analyser avec OCR
        </button>

        <button id="speak" class="btn btn-primary hidden">
            üîä Lire le texte
        </button>

        <div id="loader" class="loader hidden"></div>

        <div id="result" class="result hidden">
            <h3>üìÑ Texte extrait :</h3>
            <p id="resultText"></p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract.min.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('preview');
        const startCameraBtn = document.getElementById('startCamera');
        const captureBtn = document.getElementById('capture');
        const processBtn = document.getElementById('process');
        const speakBtn = document.getElementById('speak');
        const status = document.getElementById('status');
        const loader = document.getElementById('loader');
        const result = document.getElementById('result');
        const resultText = document.getElementById('resultText');

        let stream = null;
        let capturedImage = null;
        let extractedText = '';

        // Fonction pour mettre √† jour le statut
        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status status-${type}`;
        }

        // D√©marrer la cam√©ra
        startCameraBtn.addEventListener('click', async () => {
            try {
                updateStatus('D√©marrage de la cam√©ra...', 'info');
                
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Cam√©ra arri√®re
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });

                video.srcObject = stream;
                video.classList.remove('hidden');
                preview.classList.add('hidden');
                
                startCameraBtn.classList.add('hidden');
                captureBtn.classList.remove('hidden');
                captureBtn.disabled = false;
                
                updateStatus('Cam√©ra active - Positionnez le document', 'success');
            } catch (err) {
                updateStatus('Erreur d\'acc√®s √† la cam√©ra: ' + err.message, 'error');
            }
        });

        // Capturer l'image
        captureBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedImage = canvas.toDataURL('image/jpeg', 0.95);
            
            // Afficher l'aper√ßu
            preview.src = capturedImage;
            preview.classList.remove('hidden');
            video.classList.add('hidden');
            
            // Arr√™ter la cam√©ra
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            captureBtn.classList.add('hidden');
            processBtn.classList.remove('hidden');
            
            updateStatus('Image captur√©e - Pr√™t pour l\'analyse', 'success');
        });

        // Traiter l'image avec OCR
        processBtn.addEventListener('click', async () => {
            try {
                updateStatus('Analyse OCR en cours...', 'info');
                loader.classList.remove('hidden');
                processBtn.disabled = true;
                result.classList.add('hidden');

                // Utiliser Tesseract.js pour l'OCR
                const { data: { text } } = await Tesseract.recognize(
                    capturedImage,
                    'fra+eng', // Langues fran√ßais et anglais
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                updateStatus(`OCR en cours: ${Math.round(m.progress * 100)}%`, 'info');
                            }
                        }
                    }
                );

                extractedText = text.trim();
                
                if (extractedText) {
                    resultText.textContent = extractedText;
                    result.classList.remove('hidden');
                    speakBtn.classList.remove('hidden');
                    updateStatus('Texte extrait avec succ√®s!', 'success');
                } else {
                    updateStatus('Aucun texte d√©tect√© dans l\'image', 'error');
                }

                loader.classList.add('hidden');
                processBtn.disabled = false;
                
            } catch (err) {
                updateStatus('Erreur lors de l\'OCR: ' + err.message, 'error');
                loader.classList.add('hidden');
                processBtn.disabled = false;
            }
        });

        // Synth√®se vocale
        speakBtn.addEventListener('click', () => {
            if (!extractedText) {
                updateStatus('Aucun texte √† lire', 'error');
                return;
            }

            // Arr√™ter toute lecture en cours
            window.speechSynthesis.cancel();

            // Cr√©er un nouvel objet de synth√®se vocale
            const utterance = new SpeechSynthesisUtterance(extractedText);
            utterance.lang = 'fr-FR';
            utterance.rate = 0.9; // Vitesse de lecture
            utterance.pitch = 1;
            utterance.volume = 1;

            utterance.onstart = () => {
                updateStatus('Lecture en cours...', 'info');
                speakBtn.textContent = '‚è∏Ô∏è Arr√™ter la lecture';
            };

            utterance.onend = () => {
                updateStatus('Lecture termin√©e', 'success');
                speakBtn.textContent = 'üîä Lire le texte';
            };

            utterance.onerror = (err) => {
                updateStatus('Erreur de synth√®se vocale: ' + err.error, 'error');
                speakBtn.textContent = 'üîä Lire le texte';
            };

            // Si d√©j√† en cours de lecture, arr√™ter
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                speakBtn.textContent = 'üîä Lire le texte';
                updateStatus('Lecture arr√™t√©e', 'info');
            } else {
                window.speechSynthesis.speak(utterance);
            }
        });

        // Enregistrer le Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZnVuY3Rpb24oZXZlbnQpIHsKICBzZWxmLnNraXBXYWl0aW5nKCk7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdhY3RpdmF0ZScsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgcmV0dXJuIHNlbGYuY2xpZW50cy5jbGFpbSgpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCBmdW5jdGlvbihldmVudCkgewogIGV2ZW50LnJlc3BvbmRXaXRoKGZldGNoKGV2ZW50LnJlcXVlc3QpKTsKfSk7')
                .then(() => console.log('Service Worker enregistr√©'))
                .catch(err => console.log('Erreur Service Worker:', err));
        }
    </script>
</body>
</html>